<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.63">
<title data-react-helmet="true">airflow-basics | Ezmeral MLOps!</title><meta data-react-helmet="true" name="docsearch:version" content="current,latest"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="airflow-basics | Ezmeral MLOps!"><meta data-react-helmet="true" name="description" content="Introduction"><meta data-react-helmet="true" property="og:description" content="Introduction"><meta data-react-helmet="true" property="og:url" content="https://kmathur2.github.io//mlops/docs/Airflow/architecture/airflow-basics"><link data-react-helmet="true" rel="shortcut icon" href="/mlops/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://kmathur2.github.io//mlops/docs/Airflow/architecture/airflow-basics"><link rel="stylesheet" href="/mlops/styles.5b62089c.css">
<link rel="preload" href="/mlops/styles.dfc352f2.js" as="script">
<link rel="preload" href="/mlops/runtime~main.01f80da4.js" as="script">
<link rel="preload" href="/mlops/main.0632f9aa.js" as="script">
<link rel="preload" href="/mlops/1.9af24300.js" as="script">
<link rel="preload" href="/mlops/2.6336e389.js" as="script">
<link rel="preload" href="/mlops/3.2ef0a894.js" as="script">
<link rel="preload" href="/mlops/1be78505.5ee174d1.js" as="script">
<link rel="preload" href="/mlops/53.1ed3336c.js" as="script">
<link rel="preload" href="/mlops/935f2afb.543846dc.js" as="script">
<link rel="preload" href="/mlops/17896441.c19f160e.js" as="script">
<link rel="preload" href="/mlops/4dadb1e5.78a15c1d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/mlops/"><img class="navbar__logo" src="/mlops/img/logo.svg" alt="Learn MLOps!"><strong class="navbar__title">Learn MLOps!</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/mlops/docs/">Docs</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/mlops/"><img class="navbar__logo" src="/mlops/img/logo.svg" alt="Learn MLOps!"><strong class="navbar__title">Learn MLOps!</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/mlops/docs/">Docs</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">airflow-basics</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="introduction"></a>Introduction<a aria-hidden="true" tabindex="-1" class="hash-link" href="#introduction" title="Direct link to heading">#</a></h1><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="airflow"></a>Airflow<a aria-hidden="true" tabindex="-1" class="hash-link" href="#airflow" title="Direct link to heading">#</a></h3><p>Apache Airflow is a platform to programmatically author, schedule and monitor workflows. Airflow is an Apache incubator project that is mature and has a good community momentum.</p><p><img alt="Airflow Multi Node" src="/mlops/assets/images/airflow-base-50d2b046e0aa42312b2b5c01f9500399.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="kubernetes-k8s"></a>Kubernetes (k8s)<a aria-hidden="true" tabindex="-1" class="hash-link" href="#kubernetes-k8s" title="Direct link to heading">#</a></h3><p>Kubernetes(k8s) is a distributed workload orchestration system similar to Borg or Mesos. K8s can orchestrate containerized workloads on bare metal or on VMs and provides primitives modelled in a declarative way to manage the compute, memory, storage, networking, isolation, and life cycle. K8s can be accessed via kubectl(cli) or the APIs that consume the declarative specs. In the backend, the intent in the declarative specs are fulfilled by k8s core controllers that take actions (like create containers, network service, mount volume etc). k8s provides building blocks for stateless (Pods, Deployment) and stateful applications (statefulset) deployment. K8s controllers for these building blocks monitor the deployed instances to ensure cardinality, host to volume mapping across recreates, recovery on failures etc. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="what-is-an-operator-in-kubernetes"></a>What is an Operator in Kubernetes<a aria-hidden="true" tabindex="-1" class="hash-link" href="#what-is-an-operator-in-kubernetes" title="Direct link to heading">#</a></h3><p>In case of some stateful applications, the declarative models provided by kubernetes are not sufficient to handle fault remediation, scaling with data integrity and availability. This is where an K8s Operator pattern excels. An operator encapsulates an application&#x27;s operational domain knowledge and enable common day-N operations. An operator is an application-specific controller that extends the Kubernetes API to create, configure and manage stateful applications. An operator API is implemented by extending the existing k8s API with Custom Resources Definitions(CRDs) that declaratively describes the intent. Custom Resources are serializable as json and are stored in the API Server. The controller can watch these Custom Resources and take actions to move the system to the desired state. This enables meaningful extension of the k8s platform and make it suitable for complex stateful applications. </p><p><code>K8s Operator = K8s API +  CRD(declarative spec) + Custom Controller</code></p><p>The goal is to ensure that Kubernetes works well as a substrate for deploying Airflow. </p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="airflow-operator-custom-resource-api"></a>Airflow Operator Custom Resource (API)<a aria-hidden="true" tabindex="-1" class="hash-link" href="#airflow-operator-custom-resource-api" title="Direct link to heading">#</a></h1><p>The Airflow operator API is implemented by extending the k8s API with Custom Resources Definitions (CRDs) that declaratively describes the intent. Custom resources are serializable as json and are stored in the API Server. The Airflow controller watches these Custom Resources and take actions to move the Airflow cluster to the desired state. All CRDs inherit the contents of ObjectMeta and TypeMeta that are common to k8s resources.
To improve cluster utilization and provide multiple users (in same trust domain) with some isolation, we are splitting the Airflow components into <code>AirflowBase</code> (common) and <code>AirflowCluster</code> (per user). <code>AirflowBase</code> includes MySQL, UI, NFS(DagStore). <code>AirflowCluster</code> includes Airflow Scheduler, Workers, Redis. This allows use cases where different users use different airflow plugins (opeartors, packages etc) in their setup.</p><p>The <a href="https://github.com/GoogleCloudPlatform/airflow-operator/blob/master/docs/api.md" target="_blank" rel="noopener noreferrer">API Design</a> details the <code>AirflowBase</code> and <code>AirflowCluster</code> Custom Resource fields.</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="airflow-operator-custom-controllers"></a>Airflow Operator Custom Controllers<a aria-hidden="true" tabindex="-1" class="hash-link" href="#airflow-operator-custom-controllers" title="Direct link to heading">#</a></h1><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="airflowbase-controller"></a>AirflowBase Controller<a aria-hidden="true" tabindex="-1" class="hash-link" href="#airflowbase-controller" title="Direct link to heading">#</a></h2><p>AirflowBase controller  watches for AirflowBase CR and fulfils the intent. The intent translates to creation, updation or deletion of Statefulsets, Services, PVCs for MySQL, NFS.</p><p><img alt="Airflow Base" src="/mlops/assets/images/airflow-base-50d2b046e0aa42312b2b5c01f9500399.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="mysql"></a>MySQL<a aria-hidden="true" tabindex="-1" class="hash-link" href="#mysql" title="Direct link to heading">#</a></h4><p>If MySQLSpec is specified and .operator is False a simple statefulset with a single instance of MySQL is deployed. This is not recommended for production deployments. For production cases, use CloudSQL connected using SQLProxy.</p><p>TODO
If .operator is True, a MySQLCluster and MySQLBackupSchedule CRs are created to deploy a MySQL cluster. MySQL Operator needs to be installed for handling the Custom Resources. </p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="statefulset"></a>StatefulSet<a aria-hidden="true" tabindex="-1" class="hash-link" href="#statefulset" title="Direct link to heading">#</a></h4><p>MySQL, SQLProxy, NFS cluster are all deployed as stateful sets. StatefulSet creates the desired number of pods and ensures pod-hostname to volume mapping. This is useful when a pod dies and a new pod takes its place. The network identity of the new pod is set to that of the pod being replaced. Similarly the volume mounted on the old pod is moved to the new pod. </p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="endpoint-service"></a>EndPoint (Service)<a aria-hidden="true" tabindex="-1" class="hash-link" href="#endpoint-service" title="Direct link to heading">#</a></h4><p>The AirflowUI and NFS cluster are exposed via a service for use by the users and AirflowClusters.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="persistent-volumes-and-claims"></a>Persistent Volumes and claims<a aria-hidden="true" tabindex="-1" class="hash-link" href="#persistent-volumes-and-claims" title="Direct link to heading">#</a></h4><p>NFS cluster and MySQL use PVCs for data durability in the face of temporary compute degradation. Persistent Volume(PV) matching the Persistent Volume Claim(PVC)  is used when pods are created. If a matching PV is not found, dynamic provisioning is used to provision a PV and attached to the PVC created by the StatefulSets. For an elastic scalable service, dynamic provisioning is prefered. </p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="pods"></a>Pods<a aria-hidden="true" tabindex="-1" class="hash-link" href="#pods" title="Direct link to heading">#</a></h4><p>StatefulSet creates Pods. For NFS and MySQL, Persistent Volumes are attached to the Pod based on the PVC in the StatefulSet spec.  The AirflowUI and SQL-Proxy pods are simple single purpose pods and do not typically need data persistence. In case of MySQL controller, the details of MySQL pods can be found here. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="airflowcluster-controller"></a>AirflowCluster Controller<a aria-hidden="true" tabindex="-1" class="hash-link" href="#airflowcluster-controller" title="Direct link to heading">#</a></h2><p>AirflowCluster Controller watches for AirflowCluster CR and fulfils the intent. The intent translates to creation, updation or deletion of Statefulsets, PVCs for Airflow UI, Scheduler, Workers and Redis. This Custom Resource allows users to spin-up their own Airflow clusters for providing DAG level isolation between users. This enables multi-user (same trust domain, tenant) Airflow deployment. It also allows users to iterate faster with one-time use schedulers. Isolation in SQL is achieved by creating separate database for each cluster. The controller also handles updates to CRs. </p><p>TODO
It could drain celery workers nodes and k8s executor pods to prepare for upgrade.
Restarting airflow UI and Scheduler on detecting new DAGs in the DAG folder.</p><p><img alt="Airflow Cluster" src="/mlops/assets/images/airflow-base-50d2b046e0aa42312b2b5c01f9500399.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="redis"></a>Redis<a aria-hidden="true" tabindex="-1" class="hash-link" href="#redis" title="Direct link to heading">#</a></h4><p>RedisSpec is required if .Spec.executor is celery.
If .operator is False a simple statefulset with a single instance of Redis is deployed. Since redis is used as a non persistent cache, either can be used for production.</p><p>TODO
If .operator is True, a  RedisReplicas custom resource is created to deploy Redis. Redis Operator needs to be installed for handling the Custom Resources. </p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="statefulset-1"></a>StatefulSet<a aria-hidden="true" tabindex="-1" class="hash-link" href="#statefulset-1" title="Direct link to heading">#</a></h4><p>Airflow Scheduler and workers are deployed as stateful sets. StatefulSet creates the desired number of pods and ensures pod-name to volume mapping. The network identity of the new pod is set to that of the pod being replaced. Similarly the volume mounted on the old pod is moved to the new pod. </p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="endpoint-service-1"></a>EndPoint (service)<a aria-hidden="true" tabindex="-1" class="hash-link" href="#endpoint-service-1" title="Direct link to heading">#</a></h4><p>Since none of the services are exposed outside, Service definition is not needed. If in future we support clustered redis, we may use Service to front that cluster.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="persistent-volumes-and-claims-1"></a>Persistent Volumes and claims<a aria-hidden="true" tabindex="-1" class="hash-link" href="#persistent-volumes-and-claims-1" title="Direct link to heading">#</a></h4><p>Airflow scheduler and workers could use PVCs for mounting data volumes that contain the DAGs. The PVCs need to be <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes" target="_blank" rel="noopener noreferrer">RWX(read write many) or ROX(read only many)</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="airflow-pods"></a>Airflow Pods<a aria-hidden="true" tabindex="-1" class="hash-link" href="#airflow-pods" title="Direct link to heading">#</a></h3><p>Airflow Pods have the airflow container (scheduler,worker) and DAG Sidecar container. The DAG sidecar gets DAGs from the configured DAG source. In case of PVC as DAG source, the backing PV needs to be  mounted as RWX (RW many) or ROX (RO many). </p><p><img alt="Airflow Pods" src="/mlops/assets/images/airflow-base-50d2b046e0aa42312b2b5c01f9500399.png"></p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/kmathur2/mlops/edit/master/docs/Airflow/architecture/airflow-basics.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#airflow" class="table-of-contents__link">Airflow</a></li><li><a href="#kubernetes-k8s" class="table-of-contents__link">Kubernetes (k8s)</a></li><li><a href="#what-is-an-operator-in-kubernetes" class="table-of-contents__link">What is an Operator in Kubernetes</a></li><li><a href="#airflowbase-controller" class="table-of-contents__link">AirflowBase Controller</a></li><li><a href="#airflowcluster-controller" class="table-of-contents__link">AirflowCluster Controller</a><ul><li><a href="#airflow-pods" class="table-of-contents__link">Airflow Pods</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/mlops/docs/">Style Guide</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/kubedirector" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://twitter.com/bluek8s" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/kmathur2/mlops" target="_blank" rel="noopener noreferrer" class="footer__link-item">Learn KubeDirector on GitHub</a></li><li class="footer__item"><a href="https://github.com/kmathur2/mlops" target="_blank" rel="noopener noreferrer" class="footer__link-item">KubeDirector Lab on GitHub</a></li><li class="footer__item"><a href="https://github.com/bluek8s/kubedirector" target="_blank" rel="noopener noreferrer" class="footer__link-item">KubeDirector on GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2021 Hewlett Packard Enterprise.</div></div></div></footer></div>
<script src="/mlops/styles.dfc352f2.js"></script>
<script src="/mlops/runtime~main.01f80da4.js"></script>
<script src="/mlops/main.0632f9aa.js"></script>
<script src="/mlops/1.9af24300.js"></script>
<script src="/mlops/2.6336e389.js"></script>
<script src="/mlops/3.2ef0a894.js"></script>
<script src="/mlops/1be78505.5ee174d1.js"></script>
<script src="/mlops/53.1ed3336c.js"></script>
<script src="/mlops/935f2afb.543846dc.js"></script>
<script src="/mlops/17896441.c19f160e.js"></script>
<script src="/mlops/4dadb1e5.78a15c1d.js"></script>
</body>
</html>